<!DOCTYPE html>
	<html xmlns:th="http://www.thymeleaf.org" 
	      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	      layout:decorate="~{layouts/layout}">
	<head>
	<!-- Favicon -->
	<link rel="shortcut icon" href="/assets/images/logo/favicon.png" type="image/x-icon">	
	
	<!-- date-picker -->
	<link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.css">
	<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.js"></script>
	
	<!-- pagination -->
	<script src="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.min.js"></script>
			
	<!-- toast ë¶€íŠ¸ìŠ¤íŠ¸ë© ê¸°ë³¸ --> 
	<link rel="stylesheet" href="https://uicdn.toast.com/tui.grid/latest/tui-grid.css" /> 
 	<script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.min.js"></script> 
	
	<!-- axios ì‚¬ìš© -->	
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	
	<title>CMT</title>
	<style>
		
    .container1 {
        display: grid;
		grid-template-columns: 150px 170px 100px 200px 50px 200px 160px 150px 150px 100px 1fr; 
        gap: 3px;
        background: #f5f5f5;
        padding: 4px;
        border-radius: 5px;
		border : 1px solid black;
		text-align: center;
		width: 1600px;
    }
	
	.container2 {
        display: grid;
		grid-template-columns: 150px 200px 200px 150px 200px 200px 150px 200px 1fr; 
        gap: 3px;
        background: #f5f5f5;
        padding: 4px;
        border-radius: 5px;
		border : 1px solid black;
		text-align: center;
		width: 1600px;
    }
		
	
    .container input, .container select {
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }
	
    .button-container {
        display: flex;
        gap: 5px;
        margin: 10px;
		justify-content: space-between;
		width: 1600px;
    }
	
    button {
        padding: 5px 10px;
        border: none;
        cursor: pointer;
        border-radius: 3px;
    }
	
	.selecedRowClass {
	    background-color:aliceblue !important;
	    color: white;
	 }
	 
	 #loading-overlay {
		position: fixed;
	   	top: 0;
	   	left: 0;
	   	width: 100%;
	   	height: 100%;
	   	background-color: rgba(0, 0, 0, 0.6); /* ë°˜íˆ¬ëª…í•œ ë°°ê²½ */
	   	display: none; /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
	   	align-items: center;
	   	justify-content: center;
	   	z-index: 9999;
	 }

	.loading-content {
		text-align: center;
	   	color: white;
	 }
	
	</style>
</head>

<body>
    <div layout:fragment="content">
		<div class="button-container">
			<div><h2>ìˆ˜ì£¼ì¡°íšŒ</h2></div>
			<div>
	        <!-- <button class="request" onclick="location.href='/sales/soregisterform'">ğŸ“ƒ ì‹ ê·œ</button> -->
			<button type="button" class="btn btn-primary" onclick="location.reload()" id="completeBtn">âœï¸ í˜„ì¬ ìˆ˜ì • ëª¨ë“œ</button>
	        <button type="button" class="btn btn-primary" id="searchBtn">ğŸ” ê²€ìƒ‰</button>
	        <button type="button" class="btn btn-primary" onclick="soRegisterOpenWindows()">ğŸ“ƒ ì‹ ê·œ</button>
			<button type="button" class="btn btn-primary" id="delBtn" onclick="soDelOpenWindows()">â ì‚­ì œ</button>
	        <button type="button" class="btn btn-primary" id="pdfBtn">ğŸ–¨ï¸ ìˆ˜ì£¼ì„œ ì €ì¥</button> 
			<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#emailModal">ğŸ“§ ìˆ˜ì£¼ì„œ ë©”ì¼ë³´ë‚´ê¸°</button>
			</div>
	    </div>
		
		<form action="/sales/so" method="get" th:object="${SalesOrder}">	    
		    <div class="container1">
				<!-- ìˆ˜ì£¼ ì½”ë“œ -->
		        <label class="sell_company_label">ìˆ˜ì£¼ ì½”ë“œ</label>
				<select class="sell_select" id="soCode">
					<option value="">--ì„ íƒí•˜ì„¸ìš”--</option>
		            <option th:each="code : ${soMainList}"
						th:value="${code.soCode}"
						th:text="${code.soCode}"
					></option><!--selected="${SalesOrder.pdtCode == code}"-->
		        </select>
				
				<!-- ë‚ ì§œ ê¸°ê°„ -->
				<label class="sell_company_label">ê¸°ê°„</label>
		        <input type="date" class="sell_date1" id="startDate">
		        <span class="sell_tilt">~</span>
		        <input type="date" class="sell_date2" id="endDate">
				<select class="sell_select" id="dateType">
					<option value="">ì¼ì ìœ í˜•</option>
		            <option value="soDate">ìˆ˜ì£¼ì¼ì</option><!--selected="${SalesOrder.pdtCode == code}"-->
					<option value="shipDate">ì¶œí•˜ì¼ì</option>
		        </select>
					
				<!-- ìˆ˜ì£¼ ë²ˆí˜¸ -->			
				<label class="sell_sonum_label">ìˆ˜ì£¼ë²ˆí˜¸</label>
		        <input type="text" id="soNo" class="sell_sonum_text">
		        <span></span>
				
				<!-- ê²€ìƒ‰ ë²„íŠ¼ -->
				<span></span>
		    </div>
	
		    <div class="container2">
				<!-- ì œí’ˆ ì½”ë“œ -->
		        <label>ì œí’ˆ ì½”ë“œ</label>
				<select class="sell_select" id="pdtCode">
					<option value="">--ì„ íƒí•˜ì„¸ìš”--</option>
		            <option th:each="code : ${pdtCode}"
						th:value="${code}"
						th:text="${code}"
					></option><!-- selected="${SalesOrder.pdtCode == code}" -->
		        </select>
		        <input type="text" id="pdtName" placeholder="NAME">
		      
				<!-- ê±°ë˜ì²˜ ì½”ë“œ -->
		        <label>ê±°ë˜ì²˜ ì½”ë“œ</label>
				<select class="sell_select" id="cltCode">
					<option value="">--ì„ íƒí•˜ì„¸ìš”--</option>
		            <option th:each="code : ${cltCode}"
						th:value="${code}"
						th:text="${code}"
					></option><!-- selected="${SalesOrder.cltCode == code}" -->
		        </select>
		        <input type="text" id="cltName" placeholder="NAME">
		        
				<!-- ì§„í–‰ ìƒíƒœ -->
				<label>ì§„í–‰ìƒíƒœ</label>
				<select class="sell_select" id="soStatus">
					<option value="">--ì„ íƒí•˜ì„¸ìš”--</option>
		            <option th:each="status : ${soStatusList}"
						th:value="${status.statusCode}"
						th:text="${status.statusName}"
					></option><!--selected="${SalesOrder.cltCode == code}"-->
		        </select>
		    </div><!--  <div class="container2"> -->
		</form>
		
		<br>

		<!-- grid ì¶œë ¥ íƒœê·¸ -->
		<div id="gridTop"></div>
		
		<!-- email ëª¨ë‹¬ ì‹œì‘ -->
		<div class="modal fade" id="emailModal" tabindex="-1" insert>
		    <div class="modal-dialog" style="max-width: 40%;">
		        <div class="modal-content">
		            <div class="modal-header">
		                <h5 class="modal-title" id="empModalLabel">ìˆ˜ì£¼ì„œ ì´ë©”ì¼ ì „ì†¡</h5>
		                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		            </div>
					<!-- form-row / form-item / form-group -->
					
					
					<div style="margin: 20px;">
						<div>
						<label for="emailTxt">ë©”ì¼ ì…ë ¥</label>
						<br>
						<label for="emailTxt" style="color:red; font-size: 15px;">ìˆ˜ì£¼ì„œ ì €ì¥ ë²„íŠ¼ì„ ë¨¼ì € ì‹¤í–‰í•´ ì£¼ì„¸ìš”.</label>
						</div>
						<br>
						<div>
						<input type="text" id="emailTxt" placeholder="ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"> @ 
						<select id="emailSelected">
			                <option value="directInput">-----ì§ì ‘ì…ë ¥----</option>
							<option value="gmail.com">gmail.com(PDFíŒŒì¼ ì „ì†¡ ë¶ˆê°€)</option>
							<option value="naver.com">naver.com</option>
							<option vluae="nate.com">nate.com</option>
							<option value="outlook.com">outlook.com</option>
							<option vluae="hotmail.com">hotmail.com</option>
			            </select>
						<input type="text" id="emailDomainTxt" placeholder="ë„ë©”ì¸ì„ ì…ë ¥í•˜ì„¸ìš”">
						</div>
			        </div>
					
					
					<br>
					
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" id="sendEmailBtn">ì „ì†¡</button>
	                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancleEmailBtn">ì·¨ì†Œ</button>
	                </div>
		        </div> <!-- modal-content -->
		    </div><!-- modal-dialog modal-lg -->
		</div><!-- modal -->
		<!-- ëª¨ë‹¬ ë -->
		
		
		<div id="loading-overlay">
		  <div class="loading-content">
			<div class="progress" style="width: 500px;">
			  <div class="progress-bar" id="progressbar" role="progressbar" aria-label="Basic example" style="width: 0px" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
			</div>
		    <p>ë©”ì¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
		  </div>
		</div>
		
		
		<!-- ìë°” ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘, jQuery êµ¬ë¬¸ í¬í•¨ -->
		<script src="/js/jquery-3.7.1.js"></script>
	    <script th:inline="javascript">
			
		//===================================== Gridë¶€ë¶„ ì‹œì‘ ===============================================
		
		//ëª¨ë“  ì»¬ëŸ¼ í•¨ê¹¨ í‘œì‹œ
		let cltList = /*[[${cltList}]]*/ [];
		let empList = /*[[${empList}]]*/ [];
		let productList = /*[[${productList}]]*/ [];
		let soStatusList = /*[[${soStatusList}]]*/ [];
		
		//2ê°œì˜ ì»¬ëŸ¼ìœ¼ë¡œ labelê³¼ valueë¥¼ ë§ì¶˜ë‹¤
// 		let cltListSelected = cltList.map(item => ({label: item.cltCode, value: item.cltName+'('+item.cltCode+')'}));
// 		let empListSelected = empList.map(item => ({label: item.empNo, value: item.empName+'('+ item.empNo + ')'}));
// 		let productListSelected = productList.map(item => ({label: item.pdtCode, value: item.pdtName+'('+item.pdtCode+')'}))
// 		let soStatusListSelected = soStatusList.map(item => ({label: item.statusCode, value: item.statusName+'('+item.statusCode+')'}))
		
		let empListSelected = empList.map(item1 => ({text: item1.empName, label: item1.empName, value: item1.empId}));
		let cltListSelected = cltList.map(item2 => ({text: item2.cltName, label: item2.cltName, value: item2.cltCode}));
		let productListSelected = productList.map(item => ({text: item.pdtName, label: item.pdtName, value: item.pdtCode}));
		let soStatusListSelected = soStatusList.map(item => ({text: item.statusName, label: item.statusName, value: item.statusCode}));
		
		/*
		console.log('cltList - ',cltList)
		console.log('empList - ',empList);
		console.log('productList - ',productList)
		console.log('soStatusList - ',soStatusList);
		*/	
	    //console.log('soMainList - ',/*[[${soMainList}]]*/ []);
		
		let gridData = /*[[${soMainList}]]*/ [];
		
		//pdfì—ì„œ ê°’ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì²˜ìŒ ë¡œë”©ì‹œ ìˆ˜ì •ëª¨ë“œì™€ ajaxë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” ê²€ìƒ‰ëª¨ë“œì˜ ì»¬ëŸ¼ ëŒ€ì†Œë¬¸ìê°€ ë‹¤ë¥¸ë‹¤. 
		//ì•„ë¬´ê²ƒë„ ëª¨ë¥´ëŠ” íŒ€ì› ajaxë¡œ í–ˆì„ ë•Œ ëŒ€ë¬¸ì ìŠ¤ë„¤ì´ì´í¬ë¡œ ë°”ê¿”ì£¼ëŠ” ì„¤ì •ì„ í–ˆë‹¤.   
		let modifySearchCheck = true; //trueì¼ ë•Œ ìˆ˜ì •ëª¨ë“œ
	    
	    let grid = new tui.Grid({
	        el: document.getElementById('gridTop'), 
			//data : /*[[${soMainList}]]*/ [],
			data: gridData,
	        rowHeaders: ['checkbox'], //ìˆ˜ì •ì„ ë”°ë¡œ ì•ˆ ë§Œë“¤ê¸° ë•Œë¬¸ì— í•„ìš”ê°€ ì—†ì–´ì¡Œë‹¤
			//selectionUnit: 'row', //í–‰ ë‹¨ìœ„ì„ íƒ
			scrollX: true,
            scrollY: true,
			//width: 1600,  // ì „ì²´ ë„ˆë¹„ ì§€ì •
			//bodyHeight: 250, // ì„¸ë¡œ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ë†’ì´ ì§€ì •
			pageOptions: {
			   useClient: true,   // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í˜ì´ì§• ì‚¬ìš©
			   perPage: 10        // í˜ì´ì§€ë‹¹ í–‰ ìˆ˜
			 },
	        columns: [
				{
					header: 'ìˆ˜ì£¼ë²ˆí˜¸',
					name: 'soNo',
					width: 100,
					sortable: true, 
					filter: 'text',
					align: "center" 
	            },
	            {
	                header: 'ìˆ˜ì£¼ì½”ë“œ',
	                name: 'soCode',
					width: 200,
					sortable: true, 
					filter: 'text',
					align: "center" 
	            },
				{
	                header: 'ìˆ˜ì£¼ì¼ì',
	                name: 'soDate',
					width: 200,
					fontSize: '40',
					sortable: true, 
					filter: 'text',
					align: 'center',
					editor: {
			           type: 'datePicker',
			           options: {
			             format: 'yyyy-MM-dd',  
			             language: 'ko'
			           }
			         }
	            },
				{
	                header: 'ì¶œí•˜ì¼ì',
	                name: 'shipDate',
					width: 200,
					sortable: true, 
					filter: 'text',
					align: "center" ,
					editor: {
			           type: 'datePicker',
			           options: {
			             format: 'yyyy-MM-dd',  
			             language: 'ko'
			           }
			         }
	            },
	            {
					header: 'ì‚¬ì›ëª…',
	                name: 'empId',
					width: 200,
					sortable: true, 
					filter: 'text',
					align: 'center',
					editor: {
						type: 'select',
						options: {
							listItems: empListSelected
						}
					},
					formatter: ({ value }) => {
				    	const emp = empListSelected.find(item => item.value === value);
				    	return emp ?  emp.label : value;
				    	//return emp.label;
				    }
	            },
				{
	                header: 'ì œí’ˆëª…',
	                name: 'pdtCode', //SalseOrderì˜ entityì— ìˆëŠ” pdtCode
					width: 200,
					sortable: true, 
					filter: 'text',
					align: 'center',
					editor: {
						type: 'select',
						options: {
							listItems: productListSelected //Productsì˜ entityì— ìˆëŠ” pdtCodeì™€ pdtName
						}
					},
					formatter: ({ value }) => {
				    	const pdt = productListSelected.find(item => item.value === value);
				    	return pdt ? pdt.label : value; 
				    }
	            },
				{
	                header: 'ê±°ë˜ì²˜ëª…',
	                name: 'cltCode',
					width: 200,
					sortable: true, 
					filter: 'text',
					align: 'center',
					editor: {
						type: 'select',
						options: {
							listItems: cltListSelected
						}
					},
					formatter: ({ value }) => {
				    	const clt = cltListSelected.find(item => item.value === value);
				    	return clt ? clt.label : value; 
				    }
	            },
	            {
	                header: 'ìˆ˜ëŸ‰',
	                name: 'soQty',
					width: 100,
					sortable: true, 
					filter: 'text',
					align: "center",
					editor: "text"
	            },
	            {
	                header: 'ë‹¨ê°€',
	                name: 'pdtPrice',
					width: 150,
					sortable: true, 
					filter: 'text',
					align: "center",
					editor: "text"
	            },
				{
					header: 'ì§„í–‰ìƒíƒœ',
					name: 'soStatus', //salesOrderì˜ entityì— ìˆëŠ” soStatus
					width: 200,
					sortable: true,
					filter: 'text',
					align: 'center',
					editor: {
						type: 'select',
						options: {
							listItems: soStatusListSelected //SalesOrderStatusì˜ ë°°ì—´ ê°’ 
						}
					},
					formatter: ({ value }) => {
				    	const stu = soStatusListSelected.find(item => item.value === value);
				    	return stu ? stu.label : value; 
				    }
	            },
	        ], // ì—´ ì„¤ì •
			autoEdit: true,
			editingEvent: 'dblclick' 
	    });
	    
		let selectedEv = null;
		
		grid.on('click', ev => {
			if(selectedEv !== null){
				grid.removeRowClassName(selectedEv.rowKey, 'selecedRowClass');

			}
			
			selectedEv = ev;
			grid.addRowClassName(selectedEv.rowKey, 'selecedRowClass');
			
		});
		
		grid.on('onGridUpdated', (ev) => {
			// ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ìƒˆë¡œê³ ì¹¨ (ë¡œë“œê°€ ë‹¤ ë˜ì§€ ì•ŠëŠ” ê²½ìš° ê·¸ë¦¬ë“œê°€ í°ìƒ‰ í™”ë©´ìœ¼ë¡œ ì¶œë ¥ë  ë•Œê°€ ìˆë‹¤.)
		    grid.refreshLayout();
			
		
		});
		
		grid.on('afterChange', (ev) => {
			
			let evValue = ev.changes[0];
			let rk = evValue.rowKey;
			let rowData = grid.getRow(rk);
			let sono = rowData.soNo;
			//{rowKey: 5, columnName: 'empId', value: '930216', prevValue: '921114'}
		
			if(evValue.columnName === 'soQty' || evValue.columnName === 'pdtPrice'){
							
				let v = evValue.value?.toString().trim(); 
				
				if(isNaN(v) || v === '' ){

					setTimeout(()=>{
						Swal.fire({
						  icon: "warning",
						  title: "í•´ë‹¹ ì»¬ëŸ¼ì€ ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤."
						});
					},0);
					
					return;
				}
			
			}
						
			let sendData = {
				soNo : sono,
				columnName : evValue.columnName,
				value : evValue.value
			};
			
			$.ajax({
				url: "/sales/soeditexe",
				type: "GET",
				data: sendData,
				success: function(result) {
					console.log(result);
				},
				error: function(errorResult) {
					grid.restore(); // ì´ì „ ìƒíƒœë¡œ ë¡¤ë°±
				}
			});
	    });

		//===================================== ì¼ë°˜ í•¨ìˆ˜ ë¶€ë¶„ ì‹œì‘ ===============================================
		
		//ê·¸ë¦¬ë“œì—ì„œ ì„ íƒí•œ ê°’ì„ ì €ì¥í•  ë°°ì—´ ì„ ì–¸
		let gridCheck = [];
		
		//ì‹ ê·œ ë²„íŠ¼ í´ë¦­ì‹œ ì‹¤í–‰ë˜ëŠ” ì…ë ¥ ì°½
    	function soRegisterOpenWindows(){
			window.open("/sales/soregisterform", "_blank", "toolbar=no, menubar=no, status=no, width=800, height=600, resizable=no")	
    	}
		
		//ì‚­ì œ ë²„íŠ¼ í´ë¦­ì‹œ ì‹¤í–‰ë˜ëŠ” ìˆ˜ì • ì°½ - í˜„ì¬ ìˆ˜ì • ë²„íŠ¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
		function soDelOpenWindows(){
			
			//gridCheck = grid.getCheckedRowKeys(); ì„ íƒëœ í‚¤ê°’ ê°€ì ¸ì˜¤ê¸°
			var checkedValue = grid.getCheckedRows();
			var checkedArray = checkedValue.map(row => row.soNo)
			
			//console.log(checkedArray);
			
			if(checkedValue.length <= 0){
				
				Swal.fire({
				  icon: "warning",
				  title: "ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.",
				});
				
				return;
			}
			
			Swal.fire({
				title: 'ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
			   	text: "ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!",
			  	icon: 'warning',
			  	showCancelButton: true,
			  	confirmButtonText: 'í™•ì¸',
			  	cancelButtonText: 'ì·¨ì†Œ'
			}).then((result) => {
			  if (result.isConfirmed) {
			    
					$.ajax({
						url: "/sales/delItems",
						type: "POST",
						contentType: "application/json",
						data: JSON.stringify(checkedValue),
						success: function(result){
							if(result === "SUCCESS"){
								location.reload();
							}
						},
						error: function(msg){
							console.log("error:" + msg);
						}
					});	
			  	} 
			});
		};//soDelOpenWindows
		
		//===================================== jQuery ì‹œì‘ ===============================================
		$(document).ready(function(){
			
			
			//ìˆ˜ì • ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ "í˜„ì¬ ìˆ˜ì • ëª¨ë“œ"
			//ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ "í˜„ì¬ ê²€ìƒ‰ ëª¨ë“œ"	ë¡œ ë³€ê²½í•˜ëŠ” ì½”ë“œ
			//<button type="button" class="completeBtn" onclick="location.reload()">âœï¸ ìˆ˜ì •</button>
				       // <button type="button" class="searchBtn" id="searchBtn">ğŸ” ê²€ìƒ‰</button>
			$("#completeBtn").on('click', function(){
				modifySearchCheck = true;
				$("#completeBtn").text("âœï¸í˜„ì¬ ìˆ˜ì • ëª¨ë“œ")
				$("#searchBtn").text("ğŸ” ê²€ìƒ‰")
			});
			
			$("#searchBtn").on('click', function(){
				modifySearchCheck = false;
				$("#completeBtn").text("âœï¸ ìˆ˜ì •")
				$("#searchBtn").text("ğŸ”í˜„ì¬ ê²€ìƒ‰ ëª¨ë“œ")
			});
			
			//ì œí’ˆëª… ê°€ì ¸ì˜¤ê¸°
			$("#pdtCode").change(function(){
				let pdtValue = $("#pdtCode").val();

				$.ajax({
		           url: "/sales/getPdtName", 
		           type: "GET",       
		           //contentType: "application/json", // GETë°©ì‹ì¼ ë•Œ ì‚­ì œ
		           //data: JSON.stringify(cltValue), // POSTë°©ì‹ì¼ ë•Œ stringify ì‹¤í–‰
				   data: {pdtCode: pdtValue}, //GETë°©ì‹ ì¼ ë•Œ ì‚¬ìš©
		           success: function(response) {
		        	  	//console.log(response.CLT_CODE);
		        	  	//console.log(response.SO_NO);
						$("#pdtName").val(response);
		           },
		           error: function(error) {
		               alert(error);
		           }
		       });
			});
			
			//ê±°ë˜ì²˜ëª… ê°€ì ¸ì˜¤ê¸°
			$("#cltCode").change(function(){
				let cltValue = $("#cltCode").val();
				
				$.ajax({
		           url: "/sales/getCltName", 
		           type: "GET",       
				   data: {cltCode: cltValue},
		           success: function(response) {
						$("#cltName").val(response);
		           },
		           error: function(error) {
		               alert(error);
		           }
		       });
			});
			
			//ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ì‹œ
			$("#searchBtn").on('click', function(){
				
				let data = {
					soCode: $("#soCode").val(),
					soNo: $("#soNo").val(),
					pdtCode: $("#pdtCode").val(),
					cltCode: $("#cltCode").val(),
					soStatus: $("#soStatus").val(),
					dateType: $("#dateType").val(),
					startDate: $("#startDate").val(),
					endDate: $("#endDate").val(),
				}
				
				var s = $("#soNo").val();
				
				/*
				ì•„ë¬´ê²ƒë„ ëª¨ë¥´ëŠ” íŒ€ì›ì˜ ì„¤ì • ë•Œë¬¸ì— ì»¨íŠ¸ë¡¤ëŸ¬ë¶€í„° ë¡œë”©ì€ ì¹´ë©œì¼€ì´ìŠ¤,
				ajaxë‚˜ axios ë¹„ë™ê¸°ë¡œë¶€í„° ë¡œë”©ì€ ìŠ¤ë„¤ì´í¬ë¡œ í‘œê¸°ê°€ ë¨. 
				ë¶€ë“ì´í•˜ê²Œ Gridë¥¼ ìƒˆë¡œ ì„¤ì •í•¨ 
				*/
				
				//ì„œë²„ë¡œ ê²€ìƒ‰í•  ë°ì´í„° ì „ì†¡
				$.ajax({
					url: "/sales/searchForm",
					type: "GET",
					//contentType: "application/json",
					//data: JSON.stringify(data),
					data: data,
					success: function(response){
						//console.log(/*[[${response}]]*/ [])

						grid.resetData(response);
						//console.log(response);
						
						grid.rowHeaders
						grid.setColumns([
						{
							header: 'ìˆ˜ì£¼ë²ˆí˜¸',
							name: 'SO_NO',
							width: 100,
							//fontSize: '40',
							sortable: true, 
							filter: 'text',
							align: "center" 
			            },
			            {
			                header: 'ìˆ˜ì£¼ì½”ë“œ',
			                name: 'SO_CODE',
							width: 200,
							//fontSize: '50',
							sortable: true, 
							filter: 'text',
							align: "center" 
			            },
						{
			                header: 'ìˆ˜ì£¼ì¼ì',
			                name: 'SO_DATE',
							width: 200,
							//fontSize: '50',
							sortable: true, 
							filter: 'text',
							align: 'center',
			            },
						{
			                header: 'ì¶œí•˜ì¼ì',
			                name: 'SHIP_DATE',
							width: 200,
							//fontSize: '50',
							sortable: true, 
							filter: 'text',
							align: 'center',
			            },
			            {
							header: 'ì‚¬ì›ëª…',
			                name: 'EMP_NAME',
							width: 200,
							//fontSize: '80',
							sortable: true, 
							filter: 'text',
							align: 'center',
			            },
						{
			                header: 'ì œí’ˆëª…',
			                name: 'PDT_NAME', //SalseOrderì˜ entityì— ìˆëŠ” pdtCode
							width: 200,
							sortable: true, 
							filter: 'text',
							align: 'center',
							
			            },
						{
			                header: 'ê±°ë˜ì²˜ëª…',
			                name: 'CLT_NAME',
							width: 200,
							sortable: true, 
							filter: 'text',
							align: 'center',
			            },
			            {
			                header: 'ìˆ˜ëŸ‰',
			                name: 'SO_QTY',
							width: 100,
							sortable: true, 
							filter: 'text',
							align: "center",
			            },
			            {
			                header: 'ë‹¨ê°€',
			                name: 'PDT_PRICE',
							width: 150,
							sortable: true, 
							filter: 'text',
							align: 'center',
			            },
						{
							header: 'ì§„í–‰ìƒíƒœ',
							name: 'STATUS_NAME', //salesOrderì˜ entityì— ìˆëŠ” soStatus
							width: 200,
							sortable: true, 
							filter: 'text',
							align: 'center',
			            },
						])//grid.setColumns
					},
					error: function(error){
						alert("error msg:" + err)
					}
				});//$.ajax({
			});//$("#searchBtn").on('click', function(){
				
			//pdf ë²„íŠ¼
			$('#pdfBtn').on('click', function(){
				const selectedRows = grid.getCheckedRows(); // ë°°ì—´ë¡œ ë°˜í™˜
				
				console.log(selectedRows)
				
				if(selectedRows.length === 0){
					Swal.fire({
						icon: "warning",
					  	title: "ì„ íƒ í•­ëª© ì—†ìŒ",
						text: "í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”"
					});
					
					return;
				}
				
				//ê±°ë˜ì²˜ëª…ë§Œ ê°€ì ¸ì˜¤ê¸°
				let cltCodeArray = selectedRows.map(v => {
					
					if(modifySearchCheck){  //ìˆ˜ì •ëª¨ë“œ
						return v.cltCode;	
					}else{
						return v.CLT_CODE
					}
				})
				
				//ê±°ë˜ì²˜ëª…ì´ ì¼ì¹˜í•˜ëŠ”ì§€ check
				let cltCodeCheck = cltCodeArray.every(v => v === cltCodeArray[0])
				
				if(cltCodeCheck){
					
					/*
					convertSnakeToCamel ë¥¼ ì‚¬ìš©í•˜ê²Œë˜ë©´
						cltCode -> cltcode, cltname, ... ë¡œ ë³€í™˜
						CLT_CODE -> cltCode, CLT_NAME -> cltName, ... ë¡œ ë³€í™˜
					*/
					let camelCaseRows;
					if(modifySearchCheck){ //ìˆ˜ì •ëª¨ë“œì¸ ê²½ìš° cltCode, cltName,... : ë°”ë¡œ ì¶œë ¥
						camelCaseRows = selectedRows;
						
					}else{  //ê²€ìƒ‰ëª¨ë“œì¸ ê²½ìš° CLT_CODE, CLT_NAME,... : ë³€í™˜
						 camelCaseRows = selectedRows.map(row => convertSnakeToCamel(row));	
					}
					
					console.log(camelCaseRows);
					
					axios.post('/sales/pdf', camelCaseRows, {
					    responseType: 'blob',
					    headers: {
					        'Content-Type': 'application/json'
					    }
					}).then(response => {
						
					    const url = URL.createObjectURL(response.data);
					    window.open(url);
					}).catch(err => {
					    console.error("PDF axios error:", err);
					});
					
				}else{
					Swal.fire({
						icon: "warning",
					  	title: "ì‹¤íŒ¨",
						text: "ê±°ë˜ì²˜ëª…ì€ ëª¨ë‘ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤."
					});
					
					return;
				}
			});//$('#pdfBtn').on('click', function(){
					
			//email ëª¨ë‹¬ ì·¨ì†Œë²„íŠ¼
			$('#cancleEmailBtn').on('click', function(){
				
				$('#emailTxt').val('');
				$('#emailSelected').val('directInput');
				$('#emailDomainTxt').val('');
				$('#emailDomainTxt').removeAttr('readonly');
				$('#emailDomainTxt').css('backgroundColor','white');
				$('#emailDomainTxt').attr('placeholder', 'ë„ë©”ì¸ì„ ì…ë ¥í•˜ì„¸ìš”');	
			});
			
			//email ì…€ë ‰íŠ¸ ë°•ìŠ¤ ë³€ê²½ì‹œ
			$('#emailSelected').on('change', function(){
				
				 if($('#emailSelected').val() === 'directInput'){
					$('#emailDomainTxt').removeAttr('readonly')
					$('#emailDomainTxt').css('backgroundColor','white');
					$('#emailDomainTxt').attr('placeholder', 'ë„ë©”ì¸ì„ ì…ë ¥í•˜ì„¸ìš”');	
				 }else if($('#emailSelected').val() === 'gmail.com'){
					
					Swal.fire({
						icon: "warning",
					  	title: "gmail ì „ì†¡ ë¶ˆê°€",
						text: "gmailì€ ë³´ì•ˆìƒ PDFíŒŒì¼ì´ ì ë¶€ë˜ë©´ ë©”ì¼ ì „ì†¡ì´ ë˜ì§€ì•ŠìŒ"
					});
					
					$('#emailDomainTxt').attr('readonly', true);
					$('#emailDomainTxt').css('background-color','#CCCCFF');
					$('#emailDomainTxt').attr('placeholder', '');
					$('#emailDomainTxt').val('');
				 }else{
					$('#emailDomainTxt').attr('readonly', true);
					$('#emailDomainTxt').css('background-color','#CCCCFF');
					$('#emailDomainTxt').attr('placeholder', '');
					$('#emailDomainTxt').val('');
				 }
			});
			
			////email ëª¨ë‹¬ ì „ì†¡ë²„íŠ¼
			$('#sendEmailBtn').on('click', function(){
				
				if($('#emailTxt').val().trim() === '' || $('#emailTxt').val() === null){
					alert("ë©”ì¼ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”");
					return;
				}
				
				if($('#emailSelected').val() === 'directInput'){
					if($('#emailDomainTxt').val().trim() === '' || $('#emailDomainTxt').val() === null){
						alert("ë©”ì¼ ë„ë©”ì¸ì„ ì…ë ¥í•˜ì„¸ìš”");
						return;
					}
				}					
				
				let emailName = $('#emailTxt').val();
				let emailDomain;
				
				if($('#emailSelected').val() === 'directInput'){
					emailDomain = $('#emailDomainTxt').val();
				}else{
					emailDomain = $('#emailSelected').val();
				}
				
				let emailAddr = emailName+'@'+emailDomain;
				console.log(emailAddr);
				
				showLoading();
											
				let valuenow = parseInt($('#progressbar').attr('aria-valuenow'));
				let width = parseInt($('#progressbar').css('width'));
				let widthValue;
				
				let progressDiv = setInterval(()=>{
					
					widthValue = width+'px';
					
					$('#progressbar').attr('aria-valuenow', valuenow);
					$('#progressbar').css('width', widthValue);
					
					if(valuenow > 140){
						valuenow = -60;
					}else{
						valuenow += 20;
					}
					
					if(width > 700){
						width = -300;
					}else{
						width += 100;
					}
					
				},300);
				
				
				$.ajax({
					url: '/sales/email',
					type: 'GET',
					data: {emailAddr: emailAddr, emailDomain: emailDomain},
					success: function(result){
						
						if(result === 'SUCCESS'){
							
							setTimeout(() => {
								clearInterval(progressDiv);
								
								hideLoading();
								
								Swal.fire({
									icon: "info",
								  	title: "ì„±ê³µ",
									text: "ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤."
								});
								
								//í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
								$('#cancleEmailBtn').trigger('click');
								//ëª¨ë‹¬ ë‹«ê¸°
								$('#emailModal').modal('hide');
								//progressbarì´ˆê¸°í™”
								$('#progressbar').attr('aria-valuenow', 0);
								$('#progressbar').css('width', '0px');
								
							}, 4000)
							
						}else if(result === 'FAIL'){
							
							setTimeout(() => {
								clearInterval(progressDiv);
								
								hideLoading();
								
								Swal.fire({
									icon: "warning",
								  	title: "ì‹¤íŒ¨",
									text: "ìˆ˜ì£¼ì„œ ì €ì¥ì„ ë¨¼ì € ì‹¤í–‰í•´ ì£¼ì‹­ì‹œì˜¤."
								});
								
								$('#cancleEmailBtn').trigger('click');
								$('#emailModal').modal('hide');
								
							}, 4000)
						}else{
							setTimeout(() => {
								clearInterval(progressDiv);
								
								hideLoading();
								
								Swal.fire({
									icon: "warning",
								  	title: "ì‹¤íŒ¨",
									text: result
								});
								
								$('#cancleEmailBtn').trigger('click');
								$('#emailModal').modal('hide');
								
							}, 4000)
						}
						
					}, error: function(error){
						
					}
				});
			});
				
		})//$(document).ready(function(){
			
		//ìŠ¤ë„¤ì´í¬ë¥¼ ë‹¤ì‹œ ì¹´ë©œë¡œ ë³€ê²½
		function toCamelCase(str) {
			return str.toLowerCase().replace(/_([a-z])/g, (_, g1) => g1.toUpperCase());
		}

		function convertSnakeToCamel(obj) {
			const newObj = {};
		  	for (const key in obj) {
		    	if (Object.hasOwn(obj, key)) {
		      		const camelKey = toCamelCase(key);
		      		newObj[camelKey] = obj[key];
		    	}
		  	}
		  	return newObj;
		}

		//ë©”ì¼ ì „ì†¡ì‹œ progress show		
		function showLoading() {
			document.getElementById('loading-overlay').style.display = 'flex';
		}

		//ë©”ì¼ ì „ì†¡ì‹œ progress hide
		function hideLoading() {
		  	document.getElementById('loading-overlay').style.display = 'none';
		}

	</script>
	</div> <!-- ì—¬ê¸° ì•ˆì— ìˆì–´ì•¼ modal, grid, script, jQuery ì „ë¶€ ì‘ë™ í•œë‹¤. ì´ divëŠ”  <div layout:fragment="content"> fragment="content"ì´ë‹¤ -->

	<th:block layout:fragment="script">
	
	</th:block>
</body>

</html>